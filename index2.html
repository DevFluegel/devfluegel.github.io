<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urologie OP PWA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1, h2 {
            color: #333;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 10px;
            background: #fff;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        li:hover {
            background: #e0e0e0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 20px;
        }
        input, button {
            padding: 8px;
            margin: 5px 0;
        }
        button {
            background: #007BFF;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .note.completed {
            text-decoration: line-through;
            color: #888;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <script>
        const USER_PW = '1234';
        const EDITOR_PW = 'test1234';
        let mode = 'user';
        let isAuthenticated = false;

        // Exemplarische Daten
        const specialties = ['Urologie'];
        const categories = { Urologie: ['laparoskopisch', 'schnitt'] };
        const operations = [
            {
                id: '1',
                name: 'Flexible URS',
                details: {
                    Lagerung: ['Steinschnitt'],
                    Siebe: ['ret. Pyelogramm-Sieb oder starres URS'],
                    Abdeckung: ['TUR-Set'],
                    Nahtmaterial: ['--'],
                    Sonstiges: ['Ureterkatheter nach Ansage', 'hydrophiler Draht nach Ansage'],
                    Geräte: ['1'],
                    Flüssigkeiten: ['3.000 ml NaCl'],
                    Verband: ['--'],
                    Besonderheiten: ['--']
                },
                category: 'laparoskopisch',
                specialty: 'Urologie',
                notes: []
            },
            {
                id: '2',
                name: 'Offene Nephrektomie',
                details: {
                    Lagerung: ['Seitenlage'],
                    Siebe: ['--'],
                    Abdeckung: ['Standard-OP-Set'],
                    Nahtmaterial: ['Vicryl 2-0', 'PDS 3-0'],
                    Sonstiges: ['Wundhaken', 'Bauchdeckenhalter'],
                    Geräte: ['2'],
                    Flüssigkeiten: ['5.000 ml Ringer-Lösung'],
                    Verband: ['Steriler Verband'],
                    Besonderheiten: ['Blutstillung beachten']
                },
                category: 'schnitt',
                specialty: 'Urologie',
                notes: []
            }
        ];
        const devices = [
            { id: '1', name: 'Holmium-Laser', description: 'Hochpräzises Lasergerät zur Steinzertrümmerung.', image: '/images/holmium-laser.jpg', specialty: 'Urologie', notes: [] },
            { id: '2', name: 'Bipolares Koagulationsgerät', description: 'Gerät zur Blutstillung und Gewebekoagulation.', image: '/images/bipolar-coag.jpg', specialty: 'Urologie', notes: [] }
        ];

        function render() {
            const app = document.getElementById('app');
            const path = window.location.pathname;

            if (!isAuthenticated) {
                app.innerHTML = `
                    <h1>Login</h1>
                    <input type="password" id="password" placeholder="Passwort eingeben">
                    <button onclick="handleLogin()">Einloggen</button>
                `;
                return;
            }

            if (path === '/' || path === '') {
                renderHome();
            } else if (path.startsWith('/operations')) {
                renderOperations(path);
            } else if (path.startsWith('/devices')) {
                renderDevices(path);
            } else if (path.startsWith('/op/')) {
                renderOperation(path.split('/')[2]);
            } else if (path.startsWith('/device/')) {
                renderDevice(path.split('/')[2]);
            }
        }

        function handleLogin() {
            const password = document.getElementById('password').value;
            if (password === USER_PW) {
                mode = 'user';
                isAuthenticated = true;
            } else if (password === EDITOR_PW) {
                mode = 'editor';
                isAuthenticated = true;
            } else {
                alert('Falsches Passwort');
                return;
            }
            window.history.pushState({}, '', '/');
            render();
        }

        function renderHome() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <h1>Willkommen</h1>
                <ul>
                    <li onclick="navigate('/operations')">OP-Standards</li>
                    <li onclick="navigate('/devices')">Geräte</li>
                </ul>
                <button onclick="setMode('user')">User-Modus</button>
                <button onclick="setMode('editor')">Editor-Modus</button>
            `;
        }

        function renderOperations(path) {
            const app = document.getElementById('app');
            const parts = path.split('/').filter(Boolean);

            if (parts.length === 1) {
                app.innerHTML = `
                    <h1>Fachrichtung wählen (OP-Standards)</h1>
                    <ul>${specialties.map(s => `<li onclick="navigate('/operations/${s}')">${s}</li>`).join('')}</ul>
                `;
            } else if (parts.length === 2) {
                const specialty = parts[1];
                app.innerHTML = `
                    <h1>Unterkategorie wählen (${specialty})</h1>
                    <ul>${categories[specialty].map(c => `<li onclick="navigate('/operations/${specialty}/${c}')">${c}</li>`).join('')}</ul>
                `;
            } else if (parts.length === 3) {
                const specialty = parts[1];
                const category = parts[2];
                const filteredOps = operations.filter(o => o.specialty === specialty && o.category === category);
                app.innerHTML = `
                    <h1>Operation wählen (${specialty} - ${category})</h1>
                    <ul>${filteredOps.map(o => `<li onclick="navigate('/op/${o.id}')">${o.name}</li>`).join('')}</ul>
                `;
            }
        }

        function renderDevices(path) {
            const app = document.getElementById('app');
            const parts = path.split('/').filter(Boolean);

            if (parts.length === 1) {
                app.innerHTML = `
                    <h1>Fachrichtung wählen (Geräte)</h1>
                    <ul>${specialties.map(s => `<li onclick="navigate('/devices/${s}')">${s}</li>`).join('')}</ul>
                `;
            } else if (parts.length === 2) {
                const specialty = parts[1];
                const filteredDevices = devices.filter(d => d.specialty === specialty);
                app.innerHTML = `
                    <h1>Gerät wählen (${specialty})</h1>
                    <ul>${filteredDevices.map(d => `<li onclick="navigate('/device/${d.id}')">${d.name}</li>`).join('')}</ul>
                `;
            }
        }

        function renderOperation(id) {
            const app = document.getElementById('app');
            const operation = operations.find(o => o.id === id);
            const opDevices = devices.filter(d => operation.details.Geräte.includes(d.id));

            app.innerHTML = `
                <h1>${operation.name}</h1>
                ${Object.entries(operation.details).map(([key, value]) => `
                    <div class="section">
                        <h2>${key}</h2>
                        ${key === 'Geräte' ? `
                            <ul>${opDevices.map(d => `<li onclick="navigate('/device/${d.id}')">${d.name}</li>`).join('')}</ul>
                        ` : mode === 'editor' ? `
                            ${value.map((v, i) => `
                                <input id="${key}_${i}" value="${v}">
                            `).join('')}
                            <button onclick="saveOperation('${id}', '${key}')">Speichern</button>
                        ` : `
                            <ul>${value.map(v => `<li>${v}</li>`).join('')}</ul>
                        `}
                    </div>
                `).join('')}
                <div class="section">
                    <h2>Notizen</h2>
                    <ul>${operation.notes.map(n => `
                        <li class="${n.is_completed ? 'completed' : ''}">
                            ${n.content}
                            ${mode === 'editor' ? `
                                <button onclick="toggleNote('${id}', 'operation', '${n.id}')">Erledigt</button>
                                <button onclick="deleteNote('${id}', 'operation', '${n.id}')">Löschen</button>
                            ` : ''}
                        </li>
                    `).join('')}</ul>
                    <input id="newNote" placeholder="Neue Notiz">
                    <button onclick="addNote('${id}', 'operation')">Hinzufügen</button>
                </div>
            `;
        }

        function renderDevice(id) {
            const app = document.getElementById('app');
            const device = devices.find(d => d.id === id);

            app.innerHTML = `
                <h1>${device.name}</h1>
                <div class="section">
                    ${mode === 'editor' ? `
                        <input id="description" value="${device.description}">
                        <button onclick="saveDevice('${id}')">Speichern</button>
                    ` : `<p>${device.description}</p>`}
                    ${device.image ? `<img src="${device.image}" alt="${device.name}" style="max-width: 300px;">` : ''}
                </div>
                <div class="section">
                    <h2>Notizen</h2>
                    <ul>${device.notes.map(n => `
                        <li class="${n.is_completed ? 'completed' : ''}">
                            ${n.content}
                            ${mode === 'editor' ? `
                                <button onclick="toggleNote('${id}', 'device', '${n.id}')">Erledigt</button>
                                <button onclick="deleteNote('${id}', 'device', '${n.id}')">Löschen</button>
                            ` : ''}
                        </li>
                    `).join('')}</ul>
                    <input id="newNote" placeholder="Neue Notiz">
                    <button onclick="addNote('${id}', 'device')">Hinzufügen</button>
                </div>
            `;
        }

        function navigate(path) {
            window.history.pushState({}, '', path);
            render();
        }

        function setMode(newMode) {
            if (newMode === 'editor' && mode !== 'editor') {
                const pw = prompt('Editor-Passwort eingeben:');
                if (pw !== EDITOR_PW) {
                    alert('Falsches Passwort');
                    return;
                }
            }
            mode = newMode;
            render();
        }

        function saveOperation(id, field) {
            const values = Array.from(document.querySelectorAll(`input[id^="${field}_"]`)).map(input => input.value);
            const op = operations.find(o => o.id === id);
            op.details[field] = values;
            // Hier würde normalerweise ein fetch zum Backend gehen
            render();
        }

        function saveDevice(id) {
            const description = document.getElementById('description').value;
            const dev = devices.find(d => d.id === id);
            dev.description = description;
            // Hier würde normalerweise ein fetch zum Backend gehen
            render();
        }

        function addNote(entityId, entityType) {
            const content = document.getElementById('newNote').value;
            const entity = entityType === 'operation' ? operations.find(o => o.id === entityId) : devices.find(d => d.id === entityId);
            entity.notes.push({ id: Date.now().toString(), content, is_completed: false });
            // Hier würde normalerweise ein fetch zum Backend gehen
            render();
        }

        function toggleNote(entityId, entityType, noteId) {
            const entity = entityType === 'operation' ? operations.find(o => o.id === entityId) : devices.find(d => d.id === entityId);
            const note = entity.notes.find(n => n.id === noteId);
            note.is_completed = true;
            // Hier würde normalerweise ein fetch zum Backend gehen
            render();
        }

        function deleteNote(entityId, entityType, noteId) {
            const entity = entityType === 'operation' ? operations.find(o => o.id === entityId) : devices.find(d => d.id === entityId);
            entity.notes = entity.notes.filter(n => n.id !== noteId);
            // Hier würde normalerweise ein fetch zum Backend gehen
            render();
        }

        window.onpopstate = render;
        render();
    </script>
</body>
</html>